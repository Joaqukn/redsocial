<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Souls Social - Inicio</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>

<body>
  <nav>
    <div class="nav-left"><a href="index.html">üî∑ Souls Social</a></div>
    <div class="nav-right" id="navRight"></div>
  </nav>

  <main class="main-section">
    <div class="create-container">
      <a href="create.html" class="create-btn fixed">+ Crear publicaci√≥n</a>
    </div>

    <section id="postsContainer" class="posts-container">
      <div class="center-empty card">Cargando publicaciones...</div>
    </section>
  </main>

  <!-- Modal general -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const navRight = document.getElementById('navRight');
  const username = localStorage.getItem('username');
  
  if (username) {
    navRight.innerHTML = `<span>üë§ ${username}</span><button id="logoutBtn">Cerrar sesi√≥n</button>`;
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.clear();
      location.href = 'login.html';
    });
  } else {
    navRight.innerHTML = `<a href="login.html">Iniciar sesi√≥n</a>`;
  }

  renderPosts();
});

const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');

function showModal(html) {
  modalContent.innerHTML = html;
  modalOverlay.classList.add('active');
}
function closeModal() { modalOverlay.classList.remove('active'); }

modalOverlay.addEventListener('click', e => {
  if (e.target === modalOverlay) closeModal();
});

// --- RENDER POSTS ---
async function renderPosts() {
  try {
    const res = await fetch('/api/posts');
    if (!res.ok) throw new Error('Error cargando posts');
    const postsRaw = await res.json();
    const postsContainer = document.getElementById('postsContainer');
    const currentUser = localStorage.getItem('username');
    const isAdmin = currentUser === 'admin';

    if (!postsRaw.length) {
      postsContainer.innerHTML = '<div class="center-empty card">No hay publicaciones todav√≠a.</div>';
      return;
    }

    postsContainer.innerHTML = postsRaw.map(post => {
      const comments = Array.isArray(post.comments) ? post.comments : [];
      return `
      <article class="post-card" id="post-${post.id}">
        <div class="post-header">
          <div class="post-user">
            <div class="post-avatar">${(post.user || 'A').charAt(0).toUpperCase()}</div>
            <div>
              <div class="user-name">${post.user}</div>
              <div class="post-date">${new Date(post.created_at || Date.now()).toLocaleString()}</div>
            </div>
          </div>
          ${(currentUser === post.user || isAdmin) ? `
            <div class="post-controls">
              <button class="more-btn" data-id="${post.id}">‚ãØ</button>
              <div class="popup-options" id="popup-${post.id}">
                <button class="edit-post" data-id="${post.id}" data-title="${post.title || ''}" data-text="${post.text || ''}">Editar</button>
                <button class="delete-post" data-id="${post.id}">Eliminar</button>
              </div>
            </div>` : ''}
        </div>

        <div class="post-content">
          <h3>${post.title || '(Sin t√≠tulo)'}</h3>
          <p>${(post.text || '').replaceAll('<', '&lt;').replaceAll('>', '&gt;')}</p>
          ${post.image ? `<img src="${post.image}" class="post-image" loading="lazy">` : ''}
        </div>

        <div class="post-actions">
          <button class="like-btn" data-post-id="${post.id}">‚ù§Ô∏è ${post.likes || 0}</button>
          <button class="focus-comment" data-post-id="${post.id}">üí¨ ${comments.length}</button>
        </div>
      </article>`;
    }).join('');

    attachPostHandlers();

  } catch (err) {
    console.error(err);
    document.getElementById('postsContainer').innerHTML =
      '<div class="center-empty card">Error al cargar publicaciones.</div>';
  }
}

function attachPostHandlers() {
  // Popup 3 puntos
  document.querySelectorAll('.more-btn').forEach(btn => {
    btn.onclick = e => {
      const postId = btn.dataset.id;
      const popup = document.getElementById(`popup-${postId}`);
      popup.classList.toggle('active');
      document.addEventListener('click', function clickOutside(event) {
        if (!popup.contains(event.target) && event.target !== btn) {
          popup.classList.remove('active');
          document.removeEventListener('click', clickOutside);
        }
      });
    };
  });

  // Likes
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.onclick = async e => {
      const postId = btn.dataset.postId;
      const username = localStorage.getItem('username') || 'An√≥nimo';

      const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
      userLikes[username] = userLikes[username] || [];

      if (userLikes[username].includes(postId)) {
        alert("Ya diste like a esta publicaci√≥n.");
        return;
      }

      const res = await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
      if (!res.ok) return;

      userLikes[username].push(postId);
      localStorage.setItem('userLikes', JSON.stringify(userLikes));

      // Solo actualizar contador del post
      const currentCount = parseInt(btn.textContent.replace(/\D/g, '')) || 0;
      btn.textContent = `‚ù§Ô∏è ${currentCount + 1}`;
    };
  });

  // Mini perfil
  document.querySelectorAll('.post-avatar, .user-name').forEach(el => {
    el.style.cursor = 'pointer';
    el.onclick = () => {
      const username = el.textContent.trim();
      showMiniProfile(username);
    };
  });

  // Comentarios
  document.querySelectorAll('.focus-comment').forEach(btn => {
    btn.onclick = async () => {
      const postId = btn.dataset.postId;

      const res = await fetch(`/api/posts/${postId}`);
      if (!res.ok) return;
      const post = await res.json();
      const comments = Array.isArray(post.comments) ? post.comments : [];

      showModal(`
        <div class="comments-popup">
          <h3>Comentarios</h3>
          <ul id="commentsList">
            ${comments.length ? comments.map(c => `<li class="comment-item"><strong>${c.user}</strong>: ${c.text}</li>`).join('') : '<p>No hay comentarios a√∫n.</p>'}
          </ul>
          <form id="popupCommentForm">
            <input name="comment" type="text" placeholder="Escribe un comentario..." required>
            <button type="submit">Enviar</button>
          </form>
        </div>
      `);

      const form = document.getElementById('popupCommentForm');
      form.onsubmit = async e => {
        e.preventDefault();
        const commentText = form.comment.value.trim();
        if (!commentText) return;
        const user = localStorage.getItem('username') || 'An√≥nimo';

        const res = await fetch(`/api/posts/${postId}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, text: commentText })
        });
        if (!res.ok) return;

        // Limpiar input
        form.comment.value = '';

        // A√±adir comentario directamente al DOM
        const commentsList = document.getElementById('commentsList');
        const li = document.createElement('li');
        li.className = 'comment-item';
        li.innerHTML = `<strong>${user}</strong>: ${commentText}`;
        commentsList.appendChild(li);

        // Actualizar contador en el post
        const postBtn = document.querySelector(`.focus-comment[data-post-id="${postId}"]`);
        const currentCount = parseInt(postBtn.textContent.replace(/\D/g, '')) || 0;
        postBtn.textContent = `üí¨ ${currentCount + 1}`;
      };
    };
  });

  // Editar publicaci√≥n
  document.querySelectorAll('.edit-post').forEach(btn => {
    btn.onclick = () => {
      const postId = btn.dataset.id;
      const oldTitle = btn.dataset.title;
      const oldText = btn.dataset.text;
      showModal(`
        <h3>Editar Publicaci√≥n</h3>
        <input id="editTitle" type="text" value="${oldTitle}" placeholder="T√≠tulo">
        <textarea id="editText">${oldText}</textarea>
        <button class="confirm" id="saveEdit">Guardar</button>
        <button class="cancel" id="cancelEdit">Cancelar</button>
      `);
      document.getElementById('saveEdit').onclick = async () => {
        const title = document.getElementById('editTitle').value.trim();
        const text = document.getElementById('editText').value.trim();
        await fetch(`/api/posts/${postId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, text })
        });

        // Actualizar solo el post editado
        const postCard = document.getElementById(`post-${postId}`);
        postCard.querySelector('h3').textContent = title || '(Sin t√≠tulo)';
        postCard.querySelector('.post-content p').textContent = text;

        closeModal();
      };
      document.getElementById('cancelEdit').onclick = closeModal;
    };
  });

  // Eliminar publicaci√≥n
  document.querySelectorAll('.delete-post').forEach(btn => {
    btn.onclick = () => {
      const postId = btn.dataset.id;
      showModal(`
        <h3>Eliminar Publicaci√≥n</h3>
        <p>¬øEst√°s seguro que deseas eliminar esta publicaci√≥n?</p>
        <button class="confirm" id="confirmDelete">Eliminar</button>
        <button class="cancel" id="cancelDelete">Cancelar</button>
      `);
      document.getElementById('confirmDelete').onclick = async () => {
        await fetch(`/api/posts/${postId}`, { method: 'DELETE' });

        // Quitar solo el post del DOM
        const postCard = document.getElementById(`post-${postId}`);
        postCard.remove();
        closeModal();
      };
      document.getElementById('cancelDelete').onclick = closeModal;
    };
  });
}

// --- MINI PERFIL ---
async function showMiniProfile(username) {
  const user = {
    username,
    bio: "Amante de las almas perdidas üëª",
    postsCount: Math.floor(Math.random() * 20),
    followers: Math.floor(Math.random() * 100)
  };
  showModal(`
    <div class="profile-card">
      <div class="profile-avatar">${username.charAt(0).toUpperCase()}</div>
      <h3>${user.username}</h3>
      <p>${user.bio}</p>
      <p>Publicaciones: ${user.postsCount}</p>
      <p>Seguidores: ${user.followers}</p>
    </div>
  `);
}
</script>
</body>
</html>
