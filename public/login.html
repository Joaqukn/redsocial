<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!--  Evitar cualquier tipo de cach茅 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Iniciar sesi贸n - Souls Social</title>
  <!--  Agregar versi贸n para forzar recarga del CSS -->
  <link rel="stylesheet" href="login.css?v=20251105" />
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body>

  <!-- Navbar -->
  <nav id="navbar">
    <div class="nav-left"><a href="index.html" class="brand">SoulsSocial</a></div>
    <div class="nav-right" id="navRight"></div> 
  </nav>

  <!-- Fondo animado -->
  <div class="background-fantasy"></div>

  <!-- Contenedor login -->
  <main class="auth-container">
    <div class="auth-card">
      <h2>Iniciar sesi贸n</h2>

      <form id="loginForm" class="auth-form">
        <div class="input-wrapper">
          <span class="input-icon"><i data-lucide="mail"></i></span>
          <input id="emailInput" name="email" type="email" placeholder="Correo electr贸nico" required />
        </div>

        <div class="input-wrapper password-wrapper">
          <span class="input-icon"><i data-lucide="lock"></i></span>
          <input id="passwordInput" name="password" type="password" placeholder="Contrase帽a" required />
          <button type="button" class="password-toggle" data-target="passwordInput">
            <i data-lucide="eye"></i>
          </button>
        </div>

        <button type="submit" class="btn">Entrar</button>
      </form>

      <div class="auth-footer">
        驴No tienes cuenta? <a href="register.html">Reg铆strate</a>
      </div>
    </div>
  </main>

  <!-- Popup de error -->
  <div id="popup-overlay" class="popup-overlay hidden">
    <div id="popup" class="popup">
      <div id="popup-icon" class="popup-icon">401</div>
      <h2 id="popup-title">Un espelunante error ocurrio</h2>
      <p id="popup-description">Lo sentimos, la p谩gina que buscas no existe.</p>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();

  // Navbar din谩mica
  const navRight = document.getElementById('navRight');
  const username = localStorage.getItem('username');
  navRight.innerHTML = username
    ? `<span> ${username}</span><button id="logoutBtn">Cerrar sesi贸n</button>`
    : `<a href="login.html">Iniciar sesi贸n</a>`;
  const logoutBtn = document.getElementById('logoutBtn');
  if(logoutBtn){
    logoutBtn.addEventListener('click', ()=>{
      localStorage.clear();
      location.href='login.html';
    });
  }

  // Toggle mostrar/ocultar contrase帽a
  document.querySelectorAll('.password-toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input = document.getElementById(btn.dataset.target);
      if(!input) return;
      if(input.type==='password'){ input.type='text'; btn.querySelector('i').setAttribute('data-lucide','eye-off'); }
      else { input.type='password'; btn.querySelector('i').setAttribute('data-lucide','eye'); }
      lucide.createIcons();
    });
  });

  // Login submit
  const loginForm = document.getElementById('loginForm');
  loginForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled=true;
    btn.textContent='Cargando...';
    try {
      const data = Object.fromEntries(new FormData(loginForm).entries());
      const res = await fetch('/api/users/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      });
      if(res.ok){
        const r = await res.json();
        localStorage.setItem('username', r.username);
        localStorage.setItem('email', data.email);
        btn.textContent='隆Bienvenido!';
        setTimeout(()=>location.href='index.html',400);
      } else {
        const err = await res.json().catch(()=>({message:'Error'}));
        showPopup(err.message || 'Error al iniciar sesi贸n');
      }
    } catch {
      showPopup('Error de red. Intenta de nuevo.');
    } finally {
      btn.disabled=false;
      btn.textContent='Entrar';
    }
  });

  function showPopup(msg){
    const overlay = document.getElementById('popup-overlay');
    overlay.querySelector('p').textContent=msg;
    overlay.classList.remove('hidden');
    setTimeout(()=>overlay.classList.add('hidden'),2500);
  }

  // Animar letras de la navbar
  const brand = document.querySelector('nav .brand');
  if (brand){
    const text = brand.textContent;
    brand.textContent='';
    text.split('').forEach(char=>{
      const span=document.createElement('span');
      span.textContent=char;
      brand.appendChild(span);
    });
  }

});
</script>
</body>
</html>
