<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- 游댠 Evitar cualquier tipo de cach칠 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Registrarse - Souls Social</title>
  <!-- 游댠 Agregar versi칩n para forzar recarga del CSS -->
  <link rel="stylesheet" href="login.css?v=20251105" />
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body>

  <!-- Navbar -->
  <nav id="navbar">
    <div class="nav-left"><a href="index.html" class="brand">SoulsSocial</a></div>
    <div class="nav-right" id="navRight"></div> 
  </nav>

  <!-- Fondo animado -->
  <div class="background-fantasy"></div>

  <!-- Contenedor registro -->
  <main class="auth-container">
    <div class="auth-card">
      <h2>Crear cuenta</h2>

      <form id="registerForm" class="auth-form">
        <div class="input-wrapper">
          <span class="input-icon"><i data-lucide="user"></i></span>
          <input name="username" type="text" placeholder="Nombre de usuario" required />
        </div>

        <div class="input-wrapper">
          <span class="input-icon"><i data-lucide="mail"></i></span>
          <input name="email" type="email" placeholder="Correo electr칩nico" required />
        </div>

        <div class="input-wrapper password-wrapper">
          <span class="input-icon"><i data-lucide="lock"></i></span>
          <input id="regPassword" name="password" type="password" placeholder="Contrase침a" required />
          <button type="button" class="password-toggle" data-target="regPassword">
            <i data-lucide="eye"></i>
          </button>
        </div>

        <button type="submit" class="btn">Registrarse</button>
      </form>

      <div class="auth-footer">
        쯏a tienes cuenta? <a href="login.html">Inicia sesi칩n</a>
      </div>
    </div>
  </main>

  <!-- Popup de error -->
  <div id="popup-overlay" class="popup-overlay hidden">
    <div id="popup" class="popup">
      <div id="popup-icon" class="popup-icon">401</div>
      <h2 id="popup-title">Un espelunante error ocurrio</h2>
      <p id="popup-description">Aqu칤 ir치 la descripci칩n del error.</p>
    </div>
  </div>

  <script>

    // Navbar din치mica
    (function(){
      const navRight = document.getElementById('navRight');
      const username = localStorage.getItem('username');
      navRight.innerHTML = username
        ? `<span>游녻 ${username}</span><button id="logoutBtn">Cerrar sesi칩n</button>`
        : `<a href="login.html">Iniciar sesi칩n</a>`;
      const logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn) logoutBtn.addEventListener('click', ()=>{ localStorage.clear(); location.href='login.html'; });
    })();

    // Toggle mostrar/ocultar contrase침a
    document.querySelectorAll('.password-toggle').forEach(btn=>{
      btn.addEventListener('click', e=>{
        e.preventDefault();
        const input = document.getElementById(btn.dataset.target);
        if(!input) return;
        const showing = input.type === 'text';
        input.type = showing ? 'password' : 'text';
        btn.querySelector('i').setAttribute('data-lucide', showing ? 'eye' : 'eye-off');
        lucide.createIcons();
      });
    });

    // Popup de error
    function showPopup(msg){
      const overlay = document.getElementById('popup-overlay');
      overlay.querySelector('p').textContent = msg;
      overlay.classList.remove('hidden');
      setTimeout(()=> overlay.classList.add('hidden'), 2500);
    }

    // Submit del registro (AJAX)
    const registerForm = document.getElementById('registerForm');
    registerForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Cargando...';
      try {
        const data = Object.fromEntries(new FormData(registerForm).entries());
        const res = await fetch('/api/users/register',{
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        if(res.ok){
          const r = await res.json();
          localStorage.setItem('username', r.username);
          localStorage.setItem('email', data.email);
          btn.textContent = '춰Creado!';
          setTimeout(()=> location.href='index.html',400);
        } else {
          const err = await res.json().catch(()=>({message:'Error'}));
          showPopup(err.message || 'Error al registrarse');
        }
      } catch {
        showPopup('Error de red. Intenta de nuevo.');
      } finally {
        btn.disabled=false;
        btn.textContent='Registrarse';
      }
    });

    // Animar letras de la navbar
    document.addEventListener('DOMContentLoaded', ()=>{
      const brand = document.querySelector('nav .brand');
      if (!brand) return;
      const text = brand.textContent;
      brand.textContent = '';
      text.split('').forEach(char=>{
        const span = document.createElement('span');
        span.textContent = char;
        brand.appendChild(span);
      });
    });
  </script>

</body>
</html>
