<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Souls Social - Inicio</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body>
<nav>
  <div class="nav-left"><a href="index.html">üî∑SoulsSocial</a></div>
  <div class="nav-right" id="navRight"></div>
</nav>

<main class="main-section">
  <a href="create.html" class="create-btn">Publicar üëª</a>
  <section id="postsContainer" class="posts-container">
    <div class="center-empty card">Cargando publicaciones...</div>
  </section>
</main>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>




<script>
const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');

function showModal(html) {
  modalContent.innerHTML = html;
  modalOverlay.classList.add('active');
}
function closeModal() { modalOverlay.classList.remove('active'); }
modalOverlay.addEventListener('click', e => { if(e.target === modalOverlay) closeModal(); });

document.addEventListener('DOMContentLoaded', () => {
  const navRight = document.getElementById('navRight');
  const username = localStorage.getItem('username');
  if(username){
    navRight.innerHTML = `<span>üë§ ${username}</span><button id="logoutBtn">Cerrar sesi√≥n</button>`;
    document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); location.href='login.html'; };
  } else { navRight.innerHTML = `<a href="login.html">Iniciar sesi√≥n</a>`; }
  renderPosts();
});

async function renderPosts(){
  try {
    const res = await fetch('/api/posts');
    const posts = await res.json();
    const postsContainer = document.getElementById('postsContainer');
    const currentUser = localStorage.getItem('username');
    const isAdmin = currentUser==='admin';

    if(!posts.length){
      postsContainer.innerHTML = '<div class="center-empty card">No hay publicaciones todav√≠a.</div>';
      return;
    }

    postsContainer.innerHTML = posts.map(post=> {
      const comments = post.comments || [];
      return `
      <article class="post-card" id="post-${post._id}">
        <div class="post-header">
          <div class="post-user">
            <div class="post-avatar" data-username="${post.user}">${(post.user||'A').charAt(0).toUpperCase()}</div>
            <div>
              <div class="user-name" data-username="${post.user}">${post.user}</div>
              <div class="post-date">${new Date(post.created_at||Date.now()).toLocaleString()}</div>
            </div>
          </div>
          ${(currentUser===post.user||isAdmin)?`
          <div class="post-controls">
            <button class="more-btn" data-id="${post._id}">‚ãØ</button>
            <div class="popup-options" id="popup-${post._id}">
              <button class="edit-post" data-id="${post._id}" data-title="${post.title||''}" data-text="${post.text||''}">Editar</button>
              <button class="delete-post" data-id="${post._id}">Eliminar</button>
            </div>
          </div>`:''}
        </div>
        <div class="post-content">
          <h3>${post.title||'(Sin t√≠tulo)'}</h3>
          <p>${(post.text||'').replaceAll('<','&lt;').replaceAll('>','&gt;')}</p>
          ${post.image?`<img src="${post.image}" class="post-image" loading="lazy">`:''}
        </div>
        <div class="post-actions">
          <button class="like-btn" data-post-id="${post._id}">‚ù§Ô∏è ${post.likes||0}</button>
          <button class="focus-comment" data-post-id="${post._id}">üí¨ ${comments.length}</button>
        </div>
      </article>`;
    }).join('');

    attachPostHandlers();
  } catch(err){
    console.error(err);
    document.getElementById('postsContainer').innerHTML='<div class="center-empty card">Error al cargar publicaciones.</div>';
  }
}

function attachPostHandlers(){
  const postsContainer = document.getElementById('postsContainer');
  const currentUser = localStorage.getItem('username');
  const isAdmin = currentUser==='admin';

  postsContainer.addEventListener('click', async e=>{
    const target = e.target;

    // --- LIKE ---
    if(target.classList.contains('like-btn')){
      const postId = target.dataset.postId;
      if(!currentUser){ alert('Debes iniciar sesi√≥n'); return; }
      const res = await fetch(`/api/posts/${postId}/like`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ username:currentUser })
      });
      const data = await res.json();
      target.textContent = `‚ù§Ô∏è ${data.likes||0}`;
      return;
    }

    // --- VER PERFIL ---
    const el = target.closest('.post-avatar, .user-name');
    if(el){
      const username = el.dataset.username;
      const res = await fetch(`/api/users/${encodeURIComponent(username)}`);
      if(!res.ok){ showModal(`<p style="color:#ff5555">Usuario no encontrado</p>`); return; }
      const userData = await res.json();
      const avatarHTML = userData.avatar
        ? `<img src="${userData.avatar}" class="profile-avatar-img">`
        : `<div class="profile-avatar">${userData.username.charAt(0).toUpperCase()}</div>`;
      showModal(`
        <div class="profile-card-horizontal">
          ${avatarHTML}
          <div class="profile-info">
            <h3>${userData.username}</h3>
            <p>${userData.bio || '(Sin bio)'}</p>
            <p>Publicaciones: ${userData.postsCount || 0}</p>
            <p>Seguidores: ${userData.followers || 0}</p>
            <button class="confirm" id="addFriendBtn">Agregar amigo</button>
            <button class="confirm" id="followBtn">Seguir</button>
          </div>
        </div>
      `);
      document.getElementById('addFriendBtn').onclick = () => { alert(`Solicitud de amistad enviada a ${userData.username}`); };
      document.getElementById('followBtn').onclick = () => { alert(`Ahora sigues a ${userData.username}`); };
      return;
    }

    // --- POPUP 3 PUNTOS ---
    if(target.classList.contains('more-btn')){
      const postId = target.dataset.id;
      const popup = document.getElementById(`popup-${postId}`);
      popup.classList.toggle('active');
      document.addEventListener('click', function clickOutside(event){
        if(!popup.contains(event.target)&&event.target!==target){
          popup.classList.remove('active');
          document.removeEventListener('click', clickOutside);
        }
      });
      return;
    }

    // --- EDITAR ---
    if(target.classList.contains('edit-post')){
      const postId = target.dataset.id;
      const oldTitle = target.dataset.title;
      const oldText = target.dataset.text;
      showModal(`
        <h3>Editar Publicaci√≥n</h3>
        <input id="editTitle" type="text" value="${oldTitle}" placeholder="T√≠tulo">
        <textarea id="editText">${oldText}</textarea>
        <button class="confirm" id="saveEdit">Guardar</button>
        <button class="cancel" id="cancelEdit">Cancelar</button>
      `);
      document.getElementById('saveEdit').onclick = async ()=>{
        const title = document.getElementById('editTitle').value.trim();
        const text = document.getElementById('editText').value.trim();
        await fetch(`/api/posts/${postId}`,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title,text})
        });
        const postCard = document.getElementById(`post-${postId}`);
        postCard.querySelector('h3').textContent = title||'(Sin t√≠tulo)';
        postCard.querySelector('.post-content p').textContent = text;
        target.dataset.title = title;
        target.dataset.text = text;
        closeModal();
      };
      document.getElementById('cancelEdit').onclick = closeModal;
      return;
    }

    // --- ELIMINAR ---
    if(target.classList.contains('delete-post')){
      const postId = target.dataset.id;
      showModal(`
        <h3>Eliminar Publicaci√≥n</h3>
        <p>¬øEst√°s seguro?</p>
        <button class="confirm" id="confirmDelete">Eliminar</button>
        <button class="cancel" id="cancelDelete">Cancelar</button>
      `);
      document.getElementById('confirmDelete').onclick = async ()=>{
        await fetch(`/api/posts/${postId}`,{ method:'DELETE' });
        // Remover la publicaci√≥n del DOM
        const postCard = document.getElementById(`post-${postId}`);
        if(postCard) postCard.remove();
        // Opcional: eliminar comentarios en cascada en el DOM si estaban abiertos
        const commentsList = document.getElementById('commentsList');
        if(commentsList) commentsList.innerHTML = '';
        closeModal();
      };
      document.getElementById('cancelDelete').onclick = closeModal;
      return;
    }

if (target.classList.contains('focus-comment')) {
  const postId = target.dataset.postId;
  const postCard = document.getElementById(`post-${postId}`);
  try {
    const res = await fetch(`/api/posts/${postId}`);
    if (!res.ok) { alert('Esta publicaci√≥n ya no existe.'); return; }
    const post = await res.json();
    const comments = Array.isArray(post.comments) ? post.comments : [];

    // Render de comentarios con avatar + nombre + burbuja
    const commentsHTML = await Promise.all(comments.map(async c => {
      let avatar = `<div class="comment-avatar">${c.user.charAt(0).toUpperCase()}</div>`;
      try {
        const userRes = await fetch(`/api/users/${encodeURIComponent(c.user)}`);
        if (userRes.ok){
          const userData = await userRes.json();
          if(userData.avatar) avatar = `<img src="${userData.avatar}" class="comment-avatar-img">`;
        }
      } catch {}
      return `
        <div class="comment-text">
          ${avatar}
          <div class="comment-body">
            <div class="comment-username">${c.user}</div>
            <div class="comment-content">${c.text}</div>
          </div>
        </div>`;
    }));

    showModal(`
      <h3>Comentarios</h3>
      <div id="commentsList" style="max-height:250px; overflow-y:auto; margin-bottom:10px; padding:10px; border:1px solid #333; border-radius:12px; background:#0a1022;">
        ${commentsHTML.join('') || '<p style="color:#98a3b3;">No hay comentarios todav√≠a.</p>'}
      </div>
      <textarea id="newComment" placeholder="Escribe un comentario..." style="width:100%; padding:8px; border-radius:12px; background:#081430; color:#e8f7ff; margin-bottom:10px;"></textarea>
      <button class="confirm" id="postCommentBtn">Comentar</button>
      <button class="cancel" id="cancelCommentBtn">Cancelar</button>
    `);

    document.getElementById('cancelCommentBtn').onclick = closeModal;

    document.getElementById('postCommentBtn').onclick = async () => {
      const username = localStorage.getItem('username');
      const text = document.getElementById('newComment').value.trim();
      if(!username){ alert('Debes iniciar sesi√≥n para comentar.'); return; }
      if(!text){ alert('El comentario no puede estar vac√≠o.'); return; }

      const res = await fetch(`/api/posts/${postId}/comment`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ user: username, text })
      });
      if(!res.ok){ const err = await res.json().catch(()=>({message:'Error desconocido'})); alert(err.message); return; }

      const commentsList = document.getElementById('commentsList');
      if(!commentsList.querySelector('p')) commentsList.innerHTML='';

      // Nuevo comentario en estilo Discord
      const commentEl = document.createElement('div');
      commentEl.className='comment-text';
      commentEl.innerHTML = `
        <div class="comment-avatar">${username.charAt(0).toUpperCase()}</div>
        <div class="comment-body">
          <div class="comment-username">${username}</div>
          <div class="comment-content">${text}</div>
        </div>`;
      commentsList.prepend(commentEl);

      // Actualizar contador
      const commentBtn = postCard.querySelector('.focus-comment');
      const currentCount = parseInt(commentBtn.textContent.split(' ')[1]||0);
      commentBtn.textContent=`üí¨ ${currentCount+1}`;
      document.getElementById('newComment').value='';
    };

  } catch(err){
    console.error('Error cargando comentarios:', err);
    alert('Error cargando comentarios');
  }
}
  });
} 
</script>


</body>
</html>
