<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Souls Social - Inicio</title>
  <link rel="stylesheet" href="styles.css?v=20251107">
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body>
<nav>
  <div class="nav-left"><a href="index.html">üî∑SoulsSocial</a></div>
  <div class="nav-right" id="navRight"></div>
</nav>

<main class="main-section">
  <a href="create.html" class="create-btn">Publicar üëª</a>
  <section id="postsContainer" class="posts-container">
    <div id="polarLoader" class="polar-loader">
      <div class="ice">
        <div class="bear">
          <div class="ear left"></div>
          <div class="ear right"></div>
          <div class="head">
            <div class="face">
              <div class="eye left"></div>
              <div class="eye right"></div>
              <div class="nose"></div>
            </div>
          </div>
          <div class="sleep-bubble">
            <span id="sleepText">Z...</span>
          </div>
        </div>
      </div>
      <p>Cargando publicaciones...</p>
    </div>
  </section>
</main>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<div id="alertBoxContainer" style="
  position: fixed;
  top: 64px;
  right: 20px;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
/* ---------------------------
   VARIABLES / UTILIDADES
---------------------------- */
const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');
function showModal(html){ modalContent.innerHTML = html; modalOverlay.classList.add('active'); }
function closeModal(){ modalOverlay.classList.remove('active'); }
modalOverlay.addEventListener('click', e => { if(e.target===modalOverlay) closeModal(); });

const palabrasProhibidas = [/*... tu lista ...*/];
function contieneInsultos(texto){
  if(!texto) return false;
  const t = texto.toLowerCase();
  return palabrasProhibidas.some(p => t.includes(p));
}

function showAlert(msg, type="warn"){
  const box=document.createElement("div");
  box.textContent=msg;
  box.style.cssText=`/*... tu estilo ...*/`;
  const cont=document.getElementById("alertBoxContainer");
  cont.appendChild(box);
  requestAnimationFrame(()=>{box.style.opacity="1";box.style.transform="translateY(0)";});
  setTimeout(()=>{box.style.opacity="0";box.style.transform="translateY(-6px)";
    setTimeout(()=>box.remove(),260);
  },4000);
}

/* ---------------------------
   LOGIN Y POSTS
---------------------------- */
document.addEventListener('DOMContentLoaded',()=>{
  const navRight=document.getElementById('navRight');
  const username=localStorage.getItem('username');
  if(username){
    navRight.innerHTML=`<span>üë§ ${username}</span><button id="logoutBtn">Cerrar sesi√≥n</button>`;
    document.getElementById('logoutBtn').onclick=()=>{localStorage.clear();location.href='login.html';};
  }else navRight.innerHTML=`<a href="login.html">Iniciar sesi√≥n</a>`;
  renderPosts();
});

/* ---------------------------
   RENDER POSTS
---------------------------- */
let allPostsCache = []; // cache local
async function renderPosts(forceReload=false){
  const loader=document.getElementById('polarLoader');
  if(forceReload) loader.classList.remove('hidden');

  try{
    const res=await fetch('/api/posts');
    const posts=await res.json();
    allPostsCache = posts; // actualizar cache

    const postsContainer=document.getElementById('postsContainer');
    const currentUser=localStorage.getItem('username');
    const isAdmin=currentUser==='admin';

    if(!posts.length){
      postsContainer.innerHTML='<div class="center-empty card">No hay publicaciones todav√≠a.</div>';
      loader.classList.add('hidden');return;
    }

    postsContainer.innerHTML=posts.map(post=>{
      const comments=post.comments||[];
      const texto=`${post.title||''} ${post.text||''}`;
      const betada=contieneInsultos(texto);
      if(betada && !(currentUser===post.user||isAdmin)){
        return `<article class="post-card betada">
          <h3>Publicaci√≥n Betada üö´</h3>
          <p>Esta publicaci√≥n ha sido ocultada por uso de lenguaje inapropiado.</p>
        </article>`;
      }
      return `<article class="post-card ${betada?'post-warn':''}" id="post-${post._id}">
        <div class="post-header">
          <div class="post-user">
            <div class="post-avatar" data-username="${post.user}">${(post.user||'A').charAt(0).toUpperCase()}</div>
            <div><div class="user-name" data-username="${post.user}">${post.user}</div>
            <div class="post-date">${new Date(post.created_at||Date.now()).toLocaleString()}</div></div>
          </div>
          ${(currentUser===post.user||isAdmin)?`
          <div class="post-controls">
            <button class="more-btn" data-id="${post._id}">‚ãØ</button>
            <div class="popup-options" id="popup-${post._id}">
              <button class="edit-post" data-id="${post._id}" data-title="${post.title||''}" data-text="${post.text||''}">Editar</button>
              <button class="delete-post" data-id="${post._id}">Eliminar</button>
            </div>
          </div>`:''}
        </div>
        <div class="post-content">
          <h3>${post.title||'(Sin t√≠tulo)'}</h3>
          <p>${(post.text||'').replaceAll('<','&lt;').replaceAll('>','&gt;')}</p>
          ${(post.imageBase64||post.image)?`<img src="${post.imageBase64||post.image}" class="post-image" loading="lazy">`:''}
          ${betada?`<p style="color:#ffb84d;font-size:0.9em;margin-top:8px;">‚ö†Ô∏è Contiene lenguaje inapropiado (solo autor/admin pueden verla).</p>`:''}
        </div>
        <div class="post-actions">
          <button class="like-btn" data-post-id="${post._id}">‚ù§Ô∏è ${post.likes||0}</button>
          <button class="focus-comment" data-post-id="${post._id}">üí¨ ${comments.length}</button>
        </div>
      </article>`;
    }).join('');

    attachPostHandlers();
  }catch(err){console.error(err);showAlert("‚ùå Error al cargar publicaciones","error");}
  finally{loader.classList.add('hidden');}
}

/* ---------------------------
   HANDLERS (igual que antes)
---------------------------- */
function attachPostHandlers(){ /* tu c√≥digo tal cual */ }

/* ---------------------------
   ANIMACI√ìN Z
---------------------------- */
const sleepText=document.getElementById("sleepText");
const zPhases=["Z...","Zz..","ZzZ.","ZzZz"];
let i=0;
setInterval(()=>{sleepText.textContent=zPhases[i];i=(i+1)%zPhases.length;},700);

/* ---------------------------
   SOCKET.IO LIVE
---------------------------- */
const socket = io();
let debounce = false;
socket.on('postsUpdated', ()=>{
  if(debounce) return; // evita m√∫ltiples render simult√°neos
  debounce = true;
  renderPosts(true).finally(()=>{debounce=false});
});
</script>

</body>
</html>
