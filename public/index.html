<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Souls Social - Inicio</title>
  <link rel="stylesheet" href="styles.css?v=20251107">
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body>
<nav>
  <div class="nav-left"><a href="perfil.html">üî∑SoulsSocial</a></div>
  <div class="nav-right" id="navRight"></div>
</nav>

<button id="langButton">EN</button>

<main class="main-section">
  <a href="create.html" class="create-btn">Publicar üëª</a>
  <section id="postsContainer" class="posts-container">
    <div id="polarLoader" class="polar-loader">
      <div class="ice">
        <div class="bear">
          <div class="ear left"></div>
          <div class="ear right"></div>
          <div class="head">
            <div class="face">
              <div class="eye left"></div>
              <div class="eye right"></div>
              <div class="nose"></div>
            </div>
          </div>
          <div class="sleep-bubble">
            <span id="sleepText">Z...</span>
          </div>
        </div>
      </div>
      <p>Cargando publicaciones...</p>
    </div>
  </section>
</main>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<div id="alertBoxContainer" style="
  position: fixed;
  top: 64px;
  right: 20px;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>

// -----------------------------
// üåê SISTEMA DE IDIOMAS SIMPLE Y FUNCIONAL
// -----------------------------
const translations = {
  es: {
    publish: "Publicar üëª",
    loading: "Cargando publicaciones...",
    login: "Iniciar sesi√≥n",
    logout: "Cerrar sesi√≥n",
    noPosts: "No hay publicaciones todav√≠a."
  },
  en: {
    publish: "Post üëª",
    loading: "Loading posts...",
    login: "Log in",
    logout: "Log out",
    noPosts: "No posts yet."
  }
};

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("langButton");
  let lang = localStorage.getItem("lang") || "es";

  // üî∏ Aplica traducciones iniciales
  translateUI(lang);

  // üî∏ Cambia idioma al hacer clic
  btn.textContent = lang === "es" ? "EN" : "ES";
  btn.addEventListener("click", () => {
    lang = lang === "es" ? "en" : "es";
    localStorage.setItem("lang", lang);
    btn.textContent = lang === "es" ? "EN" : "ES";
    translateUI(lang);
  });

  // üîπ Traduce partes fijas del men√∫
  const navRight = document.getElementById("navRight");
  const username = localStorage.getItem("username");
  if (username) {
    navRight.innerHTML = `<span>üë§ ${username}</span><button id="logoutBtn">${translations[lang].logout}</button>`;
    document.getElementById("logoutBtn").onclick = () => {
      localStorage.clear();
      location.href = "login.html";
    };
  } else {
    navRight.innerHTML = `<a href="login.html">${translations[lang].login}</a>`;
  }

  // üî∏ Traduce tambi√©n despu√©s de renderPosts
  const originalRender = renderPosts;
  renderPosts = async function() {
    await originalRender();
    translateUI(lang);
  };

  renderPosts();
});

// -----------------------------
// üîπ Funci√≥n que aplica las traducciones visibles
// -----------------------------
function translateUI(lang) {
  const t = translations[lang];
  

  const createBtn = document.querySelector(".create-btn");
  if (createBtn) createBtn.textContent = t.publish;


  const loaderText = document.querySelector(".polar-loader p");
  if (loaderText) loaderText.textContent = t.loading;

 
  const postsContainer = document.getElementById("postsContainer");
  if (postsContainer && postsContainer.textContent.includes("No hay publicaciones")) {
    postsContainer.innerHTML = `<div class="center-empty card">${t.noPosts}</div>`;
  }

  const emptyCard = document.querySelector(".center-empty.card");
  if (emptyCard) {
    emptyCard.textContent = t.noPosts;
  }

  const navLink = document.querySelector("nav a[href='login.html']");
  if (navLink) navLink.textContent = t.login;
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.textContent = t.logout;
}

  

const palabrasProhibidas = [
  "idiota","imbecil","tonto","estupido","mierda","puta","puto","forro",
  "gil","pajero","concha","pelotudo","marica","rata","zorra","tarado",
  "mugroso","asco","prostituta","basura"
];
function contieneInsultos(texto){
  if(!texto) return false;
  const t = texto.toLowerCase();
  return palabrasProhibidas.some(p => t.includes(p));
}


function showAlert(msg, type="warn"){
  const box=document.createElement("div");
  box.textContent=msg;
  box.style.cssText=`padding:10px 14px;border-radius:10px;
    font-family:'Poppins',sans-serif;color:#fff;
    background:${type==="error"?"#ff4b4b":type==="success"?"#28a745":"#f5a623"};
    box-shadow:0 6px 18px rgba(0,0,0,0.35);
    opacity:0;transform:translateY(-6px);
    transition:all 230ms ease;max-width:320px;`;
  const cont=document.getElementById("alertBoxContainer");
  cont.appendChild(box);
  requestAnimationFrame(()=>{box.style.opacity="1";box.style.transform="translateY(0)";});
  setTimeout(()=>{box.style.opacity="0";box.style.transform="translateY(-6px)";
    setTimeout(()=>box.remove(),260);
  },4000);
}


const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');
function showModal(html){ modalContent.innerHTML = html; modalOverlay.classList.add('active'); }
function closeModal(){ modalOverlay.classList.remove('active'); }
modalOverlay.addEventListener('click', e => { if(e.target===modalOverlay) closeModal(); });


document.addEventListener('DOMContentLoaded',()=>{
  const navRight=document.getElementById('navRight');
  const username=localStorage.getItem('username');
  if(username){
    navRight.innerHTML=`<span>üë§ ${username}</span><button id="logoutBtn">Cerrar sesi√≥n</button>`;
    document.getElementById('logoutBtn').onclick=()=>{localStorage.clear();location.href='login.html';};
  }else navRight.innerHTML=`<a href="login.html">Iniciar sesi√≥n</a>`;

  renderPosts(); 
});


async function renderPosts() {
  const loader = document.getElementById('polarLoader');
  const postsContainer = document.getElementById('postsContainer');
  if (loader) loader.classList.remove('hidden');
  if (!postsContainer) return;

  try {
    const res = await fetch('/api/posts');
    const posts = await res.json();
    const currentUser = localStorage.getItem('username');
    const isAdmin = currentUser === 'admin';

    if (!posts.length) {
      postsContainer.innerHTML = '<div class="center-empty card">No hay publicaciones todav√≠a.</div>';
      if (loader) loader.classList.add('hidden');
      return;
    }

    postsContainer.innerHTML = posts.map(post => {
      const comments = post.comments || [];
      const texto = `${post.title || ''} ${post.text || ''}`;
      const betada = contieneInsultos(texto);

      if (betada && !(currentUser === post.user || isAdmin)) {
        return `<article class="post-card betada">
          <h3>Publicaci√≥n Betada üö´</h3>
          <p>Esta publicaci√≥n ha sido ocultada por uso de lenguaje inapropiado.</p>
        </article>`;
      }

      return `<article class="post-card ${betada ? 'post-warn' : ''}" id="post-${post._id}">
        <div class="post-header">
          <div class="post-user">
            <div class="post-avatar" data-username="${post.user}">${(post.user || 'A').charAt(0).toUpperCase()}</div>
            <div>
              <div class="user-name" data-username="${post.user}">${post.user}</div>
              <div class="post-date">${new Date(post.created_at || Date.now()).toLocaleString()}</div>
            </div>
          </div>
          ${(currentUser === post.user || isAdmin) ? `
          <div class="post-controls">
            <button class="more-btn" data-id="${post._id}">‚ãØ</button>
            <div class="popup-options" id="popup-${post._id}">
              <button class="edit-post" data-id="${post._id}" data-title="${post.title || ''}" data-text="${post.text || ''}">Editar</button>
              <button class="delete-post" data-id="${post._id}">Eliminar</button>
            </div>
          </div>` : ''}
        </div>
        <div class="post-content">
          <h3>${post.title || '(Sin t√≠tulo)'}</h3>
          <p>${(post.text || '').replaceAll('<', '&lt;').replaceAll('>', '&gt;')}</p>
          ${(post.imageBase64 || post.image) ? `<img src="${post.imageBase64 || post.image}" class="post-image" loading="lazy">` : ''}
          ${betada ? `<p class="warning-text" style="color:#ffb84d;font-size:0.9em;margin-top:8px;">‚ö†Ô∏è Contiene lenguaje inapropiado.</p>` : ''}
        </div>
        <div class="post-actions">
          <button class="like-btn" data-post-id="${post._id}">‚ù§Ô∏è ${post.likes || 0}</button>
          <button class="focus-comment" data-post-id="${post._id}">üí¨ ${comments.length}</button>
        </div>
      </article>`;
    }).join('');

    attachPostHandlers();
  } catch(err) {
    console.error(err);
    showAlert("‚ùå Error al cargar publicaciones", "error");
  } finally {
    if (loader) loader.classList.add('hidden');
  }
}


function attachPostHandlers(){
  const container=document.getElementById('postsContainer');
  const currentUser=localStorage.getItem('username');
  const isAdmin=currentUser==='admin';

  container.addEventListener('click',async e=>{
    const t=e.target;

    if(t.classList.contains('like-btn')){
      const postId=t.dataset.postId;
      if(!currentUser){showAlert("‚ö†Ô∏è Debes iniciar sesi√≥n","warn");return;}
      try {
        const r=await fetch(`/api/posts/${postId}/like`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({username:currentUser})
        });
        if(!r.ok){showAlert("‚ùå Error al dar like","error");return;}
        const d=await r.json();
        t.textContent=`‚ù§Ô∏è ${d.likes||0}`;
        socket.emit('postLiked', postId);
      } catch(err){ console.error(err); showAlert("‚ùå Error al dar like","error"); }
      return;
    }


    const u = t.closest('.post-avatar,.user-name');
    if(u){
      const username = u.dataset.username;
      try {
        const r = await fetch(`/api/profile/${encodeURIComponent(username)}`);
        if(!r.ok){ showAlert("‚ùå Usuario no encontrado","error"); return; }
        const userData = await r.json();

        const avatarHTML = userData.avatarBase64
          ? `<img src="${userData.avatarBase64}" class="profile-avatar-img">`
          : `<div class="profile-avatar">${userData.username.charAt(0).toUpperCase()}</div>`;

        showModal(`
          <div class="profile-card-horizontal">
            ${avatarHTML}
            <div class="profile-info">
              <h3>${userData.username}</h3>
              <p>${userData.bio || '(Sin bio)'}</p>
              <p>Publicaciones: ${userData.postsCount || 0}</p>
              <p>Seguidores: ${userData.followers || 0}</p>
            </div>
          </div>
        `);
      } catch(err){ console.error(err); showAlert("‚ùå Error al cargar perfil","error"); }
      return;
    }

   
    if(t.classList.contains('more-btn')){
      const postId=t.dataset.id;
      const popup=document.getElementById(`popup-${postId}`);
      if(!popup)return;
      popup.classList.toggle('active');
      document.addEventListener('click',function clickOutside(ev){
        if(!popup.contains(ev.target)&&ev.target!==t){
          popup.classList.remove('active');
          document.removeEventListener('click',clickOutside);
        }
      });
      return;
    }

    /* EDITAR PUBLICACI√ìN */
    if(t.classList.contains('edit-post')){
      const id=t.dataset.id;
      const oldT=t.dataset.title||'', oldTxt=t.dataset.text||'';
      showModal(`<h3>Editar Publicaci√≥n</h3>
        <input id="editTitle" type="text" value="${oldT}" placeholder="T√≠tulo">
        <textarea id="editText">${oldTxt}</textarea>
        <button class="confirm" id="saveEdit">Guardar</button>
        <button class="cancel" id="cancelEdit">Cancelar</button>`);
      document.getElementById('saveEdit').onclick=async()=>{
        const newT=document.getElementById('editTitle').value.trim();
        const newTxt=document.getElementById('editText').value.trim();
        if(contieneInsultos(`${newT} ${newTxt}`)){showAlert("‚ö†Ô∏è No se permiten insultos.","error");return;}
        await fetch(`/api/posts/${id}`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:newT,text:newTxt}) });
        const card=document.getElementById(`post-${id}`);
        if(card){
          card.querySelector('h3').textContent=newT||'(Sin t√≠tulo)';
          card.querySelector('.post-content p').textContent=newTxt;
          card.classList.remove('post-warn');
        }
        closeModal();
        showAlert("‚úÖ Publicaci√≥n actualizada y desbloqueada","success");
        socket.emit('postEdited', id);
      };
      document.getElementById('cancelEdit').onclick=closeModal;
      return;
    }

    /* ELIMINAR PUBLICACI√ìN */
    if(t.classList.contains('delete-post')){
      const id=t.dataset.id;
      showModal(`<h3>Eliminar Publicaci√≥n</h3><p>¬øEst√°s seguro?</p>
        <button class="confirm" id="confirmDelete">Eliminar</button>
        <button class="cancel" id="cancelDelete">Cancelar</button>`);
      document.getElementById('confirmDelete').onclick=async()=>{
        await fetch(`/api/posts/${id}`,{method:'DELETE'});
        const c=document.getElementById(`post-${id}`);
        if(c)c.remove();
        closeModal();showAlert("‚úÖ Publicaci√≥n eliminada","success");
        socket.emit('postDeleted', id);
      };
      document.getElementById('cancelDelete').onclick=closeModal;
      return;
    }

    /* COMENTARIOS */
    if(t.classList.contains('focus-comment')){
      const id=t.dataset.postId;
      const card=document.getElementById(`post-${id}`);
      try{
        const r=await fetch(`/api/posts/${id}`);
        if(!r.ok){showAlert("‚ùå Esta publicaci√≥n ya no existe","error");return;}
        const post=await r.json();
        const comments=Array.isArray(post.comments)?post.comments:[];
        const list=comments.map(c=>`
          <div class="comment-text">
            <div class="comment-avatar">${c.user.charAt(0).toUpperCase()}</div>
            <div class="comment-body">
              <div class="comment-username">${c.user}</div>
              <div class="comment-content">${c.text}</div>
            </div></div>`).join('');
        showModal(`<h3>Comentarios</h3>
          <div id="commentsList" style="max-height:250px;overflow-y:auto;margin-bottom:10px;padding:10px;border:1px solid #333;border-radius:12px;background:#0a1022;">
            ${list||'<p style="color:#98a3b3;">No hay comentarios todav√≠a.</p>'}
          </div>
          <textarea id="newComment" placeholder="Escribe un comentario..." style="width:100%;padding:8px;border-radius:12px;background:#081430;color:#e8f7ff;margin-bottom:10px;"></textarea>
          <button class="confirm" id="postCommentBtn">Comentar</button>
          <button class="cancel" id="cancelCommentBtn">Cancelar</button>`);
        document.getElementById('cancelCommentBtn').onclick=closeModal;
        document.getElementById('postCommentBtn').onclick=async()=>{
          const u=localStorage.getItem('username');
          const text=document.getElementById('newComment').value.trim();
          if(!u){showAlert("‚ö†Ô∏è Debes iniciar sesi√≥n","warn");return;}
          if(!text){showAlert("‚ö†Ô∏è El comentario no puede estar vac√≠o","warn");return;}
          if(contieneInsultos(text)){showAlert("‚ö†Ô∏è Tu comentario contiene lenguaje inapropiado","error");return;}
          const r2=await fetch(`/api/posts/${id}/comment`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user:u,text})
          });
          if(!r2.ok){showAlert("‚ùå Error al enviar comentario","error");return;}
          const list=document.getElementById('commentsList');
          const el=document.createElement('div');
          el.className='comment-text';
          el.innerHTML=`<div class="comment-avatar">${u.charAt(0).toUpperCase()}</div>
            <div class="comment-body"><div class="comment-username">${u}</div>
            <div class="comment-content">${text}</div></div>`;
          list.prepend(el);
          const btn=card.querySelector('.focus-comment');
          const n=parseInt(btn.textContent.split(' ')[1]||0);
          btn.textContent=`üí¨ ${n+1}`;
          document.getElementById('newComment').value='';
          showAlert("‚úÖ Comentario publicado","success");
          socket.emit('commentAdded', id);
        };
      }catch(err){console.error(err);showAlert("‚ùå Error cargando comentarios","error");}
    }
  });
}

/* --- Animaci√≥n Z --- */
const sleepText=document.getElementById("sleepText");
const zPhases=["Z...","Zz..","ZzZ.","ZzZz"];
let i=0;
setInterval(()=>{sleepText.textContent=zPhases[i];i=(i+1)%zPhases.length;},700);

/* ---------------------------
   SOCKET.IO EN VIVO
--------------------------- */
const socket = io();

socket.on('postLiked', updatePostCard);
socket.on('commentAdded', updatePostCard);
socket.on('postEdited', updatePostCard);
socket.on('postDeleted', postId=>{ const card=document.getElementById(`post-${postId}`); if(card) card.remove(); });
socket.on('postsUpdated',()=>{ if(document.getElementById('postsContainer')) renderPosts(); });

async function updatePostCard(postId){
  const card = document.getElementById(`post-${postId}`);
  if(!card) return;
  try{
    const res = await fetch(`/api/posts/${postId}`);
    if(!res.ok) return;
    const post = await res.json();
    const comments = post.comments || [];
    const texto = `${post.title||''} ${post.text||''}`;
    const betada = contieneInsultos(texto);
    const currentUser = localStorage.getItem('username');
    const isAdmin = currentUser==='admin';
    card.querySelector('.post-actions .like-btn').textContent=`‚ù§Ô∏è ${post.likes||0}`;
    card.querySelector('.focus-comment').textContent=`üí¨ ${comments.length}`;
    const pContent = card.querySelector('.post-content');
    pContent.querySelector('h3').textContent=post.title||'(Sin t√≠tulo)';
    pContent.querySelector('p').textContent=post.text||'';
    if(post.imageBase64 || post.image){
      let img = pContent.querySelector('img.post-image');
      if(!img){
        img = document.createElement('img'); img.className='post-image'; pContent.appendChild(img);
      }
      img.src=post.imageBase64||post.image;
    }
    card.classList.toggle('post-warn', betada && !(currentUser===post.user || isAdmin));
  }catch(err){console.error(err);}
}
</script>
</body>
</html>
